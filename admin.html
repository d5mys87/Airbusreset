<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Airbus Resets Database</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');

  :root {
    --bg: #0a0a12;
    --bg-card: #12121e;
    --bg-hover: #1a1a2e;
    --border: #2a2a42;
    --border-bright: #3a3a60;
    --text: #d0d0e8;
    --text-dim: #6868a0;
    --amber: #e8a820;
    --amber-bright: #f0c040;
    --cyan: #00ccee;
    --cyan-dim: #008899;
    --red: #ff3333;
    --red-dim: #661111;
    --green: #00cc66;
    --green-dim: #007740;
    --font-mono: 'Share Tech Mono', 'Courier New', monospace;
    --font-display: 'Rajdhani', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.07) 2px, rgba(0,0,0,0.07) 4px);
    pointer-events: none;
    z-index: 1000;
  }

  #app { max-width: 1200px; margin: 0 auto; padding: 0 20px 60px; position: relative; z-index: 1; }

  /* Header */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 0 18px; border-bottom: 1px solid var(--border);
    margin-bottom: 24px; gap: 16px; flex-wrap: wrap;
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  #logo { height: 44px; width: auto; opacity: 0.9; }
  .header-title h1 { font-family: var(--font-display); font-size: 22px; font-weight: 700; letter-spacing: 3px; color: var(--cyan); text-transform: uppercase; }
  .header-title .sub { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; margin-top: 3px; text-transform: uppercase; }
  .badge-admin { font-size: 10px; letter-spacing: 2px; color: var(--amber); border: 1px solid var(--amber); padding: 3px 10px; }

  .header-right { display: flex; align-items: center; gap: 10px; }
  .back-link { font-size: 11px; color: var(--text-dim); text-decoration: none; letter-spacing: 1px; padding: 8px 12px; border: 1px solid var(--border); transition: all 0.15s; }
  .back-link:hover { color: var(--text); border-color: var(--border-bright); }

  /* Toolbar */
  .toolbar {
    display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
  }

  .toolbar input[type="text"] {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-mono); font-size: 13px;
    padding: 9px 14px; outline: none; width: 240px;
  }
  .toolbar input[type="text"]:focus { border-color: var(--cyan-dim); }

  .toolbar select {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-mono); font-size: 13px;
    padding: 9px 14px; outline: none; cursor: pointer;
  }

  .btn {
    font-family: var(--font-mono); font-size: 12px; letter-spacing: 1px;
    padding: 9px 16px; border: 1px solid; cursor: pointer;
    transition: all 0.15s; text-transform: uppercase; background: none;
  }
  .btn-cyan { color: var(--cyan); border-color: var(--cyan-dim); }
  .btn-cyan:hover { background: rgba(0,204,238,0.1); }
  .btn-green { color: var(--green); border-color: var(--green-dim); }
  .btn-green:hover { background: rgba(0,204,102,0.1); }
  .btn-amber { color: var(--amber); border-color: var(--amber); }
  .btn-amber:hover { background: rgba(232,168,32,0.1); }
  .btn-red { color: var(--red); border-color: var(--red-dim); }
  .btn-red:hover { background: rgba(255,51,51,0.1); }

  #importFile { display: none; }

  /* Stats */
  .stats-bar {
    display: flex; gap: 20px; margin-bottom: 20px; font-size: 11px;
    color: var(--text-dim); letter-spacing: 1px; align-items: center; flex-wrap: wrap;
  }
  .stat-item span { color: var(--cyan); }

  /* Message list */
  #msgList { display: flex; flex-direction: column; gap: 6px; }

  .msg-row {
    display: flex; align-items: center; gap: 12px;
    background: var(--bg-card); border: 1px solid var(--border);
    padding: 12px 16px; cursor: pointer; transition: all 0.15s;
  }
  .msg-row:hover { background: var(--bg-hover); border-color: var(--border-bright); }
  .msg-row.selected { border-color: var(--cyan-dim); background: rgba(0,204,238,0.04); }

  .row-msgs { flex: 1; display: flex; flex-direction: column; gap: 2px; }
  .row-msg { font-size: 13px; color: var(--text); }

  .row-meta { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
  .tag { font-size: 10px; letter-spacing: 1px; padding: 2px 8px; border: 1px solid; }
  .tag-ata { color: var(--cyan); border-color: var(--cyan-dim); }
  .tag-ceo { color: var(--cyan); border-color: var(--cyan-dim); }
  .tag-neo { color: var(--amber); border-color: var(--amber); }
  .tag-both { color: var(--green); border-color: var(--green-dim); }

  .row-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .row-btn { font-family: var(--font-mono); font-size: 11px; padding: 4px 10px; border: 1px solid; cursor: pointer; background: none; letter-spacing: 1px; transition: all 0.15s; }
  .edit-btn { color: var(--amber); border-color: rgba(232,168,32,0.3); }
  .edit-btn:hover { background: rgba(232,168,32,0.1); }
  .del-btn { color: var(--red); border-color: rgba(255,51,51,0.3); }
  .del-btn:hover { background: rgba(255,51,51,0.1); }

  /* Modal */
  #modalOverlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    z-index: 500; align-items: flex-start; justify-content: center;
    padding: 40px 20px; overflow-y: auto;
  }
  #modalOverlay.open { display: flex; }

  .modal {
    background: var(--bg-card); border: 1px solid var(--border-bright);
    width: 100%; max-width: 700px; position: relative;
  }

  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
  }

  .modal-title { font-family: var(--font-display); font-size: 16px; font-weight: 600; letter-spacing: 2px; color: var(--cyan); }

  .modal-close {
    background: none; border: none; color: var(--text-dim); font-size: 20px;
    cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s;
  }
  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }

  .field input[type="text"],
  .field textarea {
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-mono); font-size: 13px;
    padding: 10px 12px; outline: none; width: 100%;
    transition: border-color 0.15s;
  }
  .field input[type="text"]:focus,
  .field textarea:focus { border-color: var(--cyan-dim); }
  .field textarea { resize: vertical; min-height: 120px; line-height: 1.6; }

  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .checkbox-group { display: flex; gap: 20px; }
  .checkbox-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; }
  .checkbox-group input { accent-color: var(--cyan); width: 14px; height: 14px; }

  /* CB editor */
  .cb-editor { display: flex; flex-direction: column; gap: 8px; }
  .cb-row { display: grid; grid-template-columns: 80px 1fr 80px 60px 100px auto; gap: 6px; align-items: center; }
  .cb-row input {
    background: var(--bg); border: 1px solid var(--border); color: var(--text);
    font-family: var(--font-mono); font-size: 12px; padding: 6px 8px; outline: none; width: 100%;
  }
  .cb-row input:focus { border-color: var(--cyan-dim); }
  .remove-cb { background: none; border: 1px solid var(--red-dim); color: var(--red); font-size: 12px; padding: 5px 8px; cursor: pointer; flex-shrink: 0; }
  .remove-cb:hover { background: rgba(255,51,51,0.1); }
  .cb-header { display: grid; grid-template-columns: 80px 1fr 80px 60px 100px auto; gap: 6px; font-size: 10px; color: var(--text-dim); letter-spacing: 1px; padding: 0 0 4px; }

  /* Password gate */
  #pwGate {
    position: fixed; inset: 0; background: var(--bg);
    z-index: 9000; display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 0;
  }
  #pwGate.hidden { display: none; }

  .pw-box {
    border: 1px solid var(--border-bright);
    background: var(--bg-card);
    padding: 40px 48px;
    display: flex; flex-direction: column; align-items: center; gap: 20px;
    min-width: 340px;
    animation: fadeIn 0.3s ease;
  }

  .pw-logo-row {
    display: flex; align-items: center; gap: 12px; margin-bottom: 4px;
  }

  .pw-logo-img { height: 38px; width: auto; opacity: 0.85; }
  .pw-logo-fallback {
    height: 38px; width: 38px; border: 2px solid var(--cyan);
    color: var(--cyan); font-family: var(--font-display);
    font-size: 18px; font-weight: 700; display: flex;
    align-items: center; justify-content: center;
  }

  .pw-title {
    font-family: var(--font-display); font-size: 18px; font-weight: 700;
    letter-spacing: 3px; color: var(--cyan); text-transform: uppercase;
  }

  .pw-sub {
    font-size: 10px; color: var(--text-dim); letter-spacing: 2px;
    text-transform: uppercase; margin-top: -10px;
  }

  .pw-label {
    font-size: 10px; letter-spacing: 3px; color: var(--text-dim);
    text-transform: uppercase; align-self: flex-start;
  }

  #pwInput {
    background: var(--bg); border: 1px solid var(--border);
    color: var(--amber-bright); font-family: var(--font-mono);
    font-size: 20px; letter-spacing: 6px; text-align: center;
    padding: 12px 20px; outline: none; width: 100%;
    transition: border-color 0.2s;
  }
  #pwInput:focus { border-color: var(--cyan-dim); }
  #pwInput.error { border-color: var(--red); animation: shake 0.35s ease; }

  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20%      { transform: translateX(-8px); }
    40%      { transform: translateX(8px); }
    60%      { transform: translateX(-5px); }
    80%      { transform: translateX(5px); }
  }

  .pw-error {
    font-size: 11px; letter-spacing: 2px; color: var(--red);
    opacity: 0; transition: opacity 0.2s; height: 16px;
  }
  .pw-error.show { opacity: 1; }

  .pw-btn {
    font-family: var(--font-mono); font-size: 12px; letter-spacing: 2px;
    padding: 12px 32px; border: 1px solid var(--cyan-dim);
    color: var(--cyan); background: none; cursor: pointer;
    text-transform: uppercase; transition: all 0.15s; width: 100%;
  }
  .pw-btn:hover { background: rgba(0,204,238,0.1); }

  .pw-attempts {
    font-size: 10px; letter-spacing: 1px; color: var(--text-dim);
  }

  /* Confirm dialog */
  #confirmOverlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    z-index: 600; align-items: center; justify-content: center;
  }
  #confirmOverlay.open { display: flex; }
  .confirm-box { background: var(--bg-card); border: 1px solid var(--red-dim); padding: 28px; max-width: 380px; text-align: center; }
  .confirm-title { font-family: var(--font-display); font-size: 16px; color: var(--red); letter-spacing: 2px; margin-bottom: 12px; }
  .confirm-msg { font-size: 13px; color: var(--text); line-height: 1.6; margin-bottom: 20px; }
  .confirm-actions { display: flex; gap: 10px; justify-content: center; }

  /* Toast */
  #toast {
    position: fixed; bottom: 24px; right: 24px; z-index: 700;
    background: var(--bg-card); border: 1px solid var(--green-dim); color: var(--green);
    font-size: 12px; letter-spacing: 1px; padding: 12px 20px;
    opacity: 0; transition: opacity 0.3s; pointer-events: none;
  }
  #toast.show { opacity: 1; }

  /* Empty */
  .empty { text-align: center; padding: 40px; color: var(--text-dim); font-size: 13px; letter-spacing: 1px; }

  /* GitHub status bar */
  .gh-bar {
    display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
    padding: 10px 14px; border: 1px solid var(--border);
    background: var(--bg-card); font-size: 11px; letter-spacing: 1px;
    flex-wrap: wrap;
  }
  .gh-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    transition: background 0.3s, box-shadow 0.3s;
  }
  .gh-dot.ok      { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .gh-dot.busy    { background: var(--amber); box-shadow: 0 0 6px var(--amber); animation: pulse 0.8s infinite; }
  .gh-dot.err     { background: var(--red);   box-shadow: 0 0 6px var(--red); }
  .gh-dot.off     { background: var(--text-dim); }
  .gh-label { color: var(--text-dim); flex: 1; min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .gh-label strong { color: var(--text); }
  .gh-cfg-btn {
    font-family: var(--font-mono); font-size: 11px; letter-spacing: 1px;
    padding: 5px 12px; border: 1px solid var(--border-bright); color: var(--text-dim);
    background: none; cursor: pointer; transition: all 0.15s; flex-shrink: 0;
  }
  .gh-cfg-btn:hover { color: var(--cyan); border-color: var(--cyan-dim); }

  /* GitHub settings modal */
  #ghModal {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.82);
    z-index: 550; align-items: center; justify-content: center; padding: 20px;
  }
  #ghModal.open { display: flex; }
  .gh-modal-box {
    background: var(--bg-card); border: 1px solid var(--cyan-dim);
    width: 100%; max-width: 520px;
  }
  .gh-modal-hdr {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px; border-bottom: 1px solid var(--border);
  }
  .gh-modal-ttl { font-family: var(--font-display); font-size: 15px; font-weight: 600; letter-spacing: 2px; color: var(--cyan); }
  .gh-modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; }
  .gh-modal-ftr { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; align-items: center; }
  .gh-help {
    font-size: 11px; color: var(--text-dim); line-height: 1.7;
    padding: 10px 14px; border-left: 2px solid var(--cyan-dim);
    background: rgba(0,204,238,0.03);
  }
  .gh-help a { color: var(--cyan); text-decoration: none; }
  .gh-help a:hover { text-decoration: underline; }
  .gh-test-msg { font-size: 11px; letter-spacing: 1px; margin-right: auto; }
</style>
</head>
<body>
<!-- Password Gate -->
<div id="pwGate">
  <div class="pw-box">
    <div class="pw-logo-row">
      <img class="pw-logo-img" src="logo.png" alt="Airbus" onerror="this.style.display='none';document.getElementById('pwLogoFallback').style.display='flex'">
      <div id="pwLogoFallback" class="pw-logo-fallback" style="display:none">A</div>
      <div class="pw-title">Airbus Resets</div>
    </div>
    <div class="pw-sub">Admin Access — Authorised Personnel Only</div>
    <div class="pw-label">Enter Password</div>
    <input type="password" id="pwInput" maxlength="32" placeholder="········" autocomplete="current-password" onkeydown="if(event.key==='Enter')checkPW()">
    <div class="pw-error" id="pwError">INCORRECT PASSWORD</div>
    <button class="pw-btn" onclick="checkPW()">UNLOCK</button>
    <div class="pw-attempts" id="pwAttempts"></div>
  </div>
</div>

<div id="app" style="display:none">

  <header>
    <div class="header-left">
      <img id="logo" src="logo.png" alt="Airbus" onerror="this.style.display='none'">
      <div class="header-title">
        <h1>Airbus Resets <span class="badge-admin">ADMIN</span></h1>
        <span class="sub">TSM A318/A319/A320/A321 · Database Manager</span>
      </div>
    </div>
    <div class="header-right">
      <a href="index.html" class="back-link">← SEARCH APP</a>
    </div>
  </header>

  <div class="toolbar">
    <input type="text" id="filterInput" placeholder="Filter messages..." oninput="renderList()">
    <select id="filterAC" onchange="renderList()">
      <option value="">ALL AIRCRAFT</option>
      <option value="CEO">CEO</option>
      <option value="NEO">NEO</option>
    </select>
    <select id="filterATA" onchange="renderList()">
      <option value="">ALL ATA</option>
    </select>
    <button class="btn btn-cyan" onclick="openAddModal()">+ ADD ENTRY</button>
    <button class="btn btn-green" onclick="exportDB()">↓ EXPORT JSON</button>
    <button class="btn btn-amber" onclick="document.getElementById('importFile').click()">↑ IMPORT JSON</button>
    <input type="file" id="importFile" accept=".json" onchange="importDB(event)">
    <button class="btn btn-red" onclick="clearOverride()">RESET DB</button>
  </div>

  <div class="stats-bar" id="statsBar"></div>

  <!-- GitHub sync status -->
  <div class="gh-bar">
    <span class="gh-dot off" id="ghDot"></span>
    <span class="gh-label" id="ghLabel">GITHUB SYNC NOT CONFIGURED — click settings to enable auto-push</span>
    <button class="gh-cfg-btn" onclick="openGHSettings()">⚙ GITHUB SETTINGS</button>
  </div>

  <div id="msgList"></div>

</div>

<!-- GitHub Settings Modal -->
<div id="ghModal">
  <div class="gh-modal-box">
    <div class="gh-modal-hdr">
      <span class="gh-modal-ttl">⚙ GITHUB SYNC SETTINGS</span>
      <button class="modal-close" onclick="closeGHSettings()">✕</button>
    </div>
    <div class="gh-modal-body">
      <div class="gh-help">
        Changes saved in admin will be pushed directly to your repo as a commit.<br>
        Requires a GitHub <strong>Personal Access Token</strong> (classic) with <strong>repo</strong> scope.<br>
        <a href="https://github.com/settings/tokens/new?scopes=repo&description=Airbus+Resets+Admin" target="_blank">→ Create a token on GitHub</a>
      </div>
      <div class="field">
        <label>Repository Owner (your GitHub username or org)</label>
        <input type="text" id="ghOwner" placeholder="e.g. demetri-papadopoulos">
      </div>
      <div class="field">
        <label>Repository Name</label>
        <input type="text" id="ghRepo" placeholder="e.g. airbus-resets">
      </div>
      <div class="field">
        <label>Branch</label>
        <input type="text" id="ghBranch" placeholder="e.g. claude/ecam-message-search-app-pU3st">
      </div>
      <div class="field">
        <label>Personal Access Token (stored in localStorage only)</label>
        <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
      </div>
    </div>
    <div class="gh-modal-ftr">
      <span class="gh-test-msg" id="ghTestMsg"></span>
      <button class="btn btn-amber" onclick="testGHConnection()">TEST CONNECTION</button>
      <button class="btn btn-red" onclick="clearGHSettings()">CLEAR</button>
      <button class="btn btn-green" onclick="saveGHSettings()">SAVE</button>
    </div>
  </div>
</div>
<div id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle">ADD ENTRY</span>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>ECAM Messages (one per line)</label>
        <textarea id="fMsgs" rows="3" placeholder="FWS FWC 1 FAULT&#10;FWS FWC 2 FAULT"></textarea>
      </div>
      <div class="field-row">
        <div class="field">
          <label>ATA Chapter</label>
          <input type="text" id="fATA" placeholder="31">
        </div>
        <div class="field">
          <label>Computer / System</label>
          <input type="text" id="fComputer" placeholder="FWC">
        </div>
      </div>
      <div class="field">
        <label>Aircraft Applicability</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="fCEO" value="CEO"> CEO (FSN 051-100)</label>
          <label><input type="checkbox" id="fNEO" value="NEO"> NEO (FSN 101-150)</label>
        </div>
      </div>
      <div class="field">
        <label>Reset Procedure (numbered steps, one per line)</label>
        <textarea id="fProc" rows="8" placeholder="1. Step one&#10;2. Step two&#10;3. Step three"></textarea>
      </div>
      <div class="field">
        <label>Warnings (one per line, or blank)</label>
        <textarea id="fWarnings" rows="2" placeholder="WARNING text if any"></textarea>
      </div>
      <div class="field">
        <label>Cautions (one per line, or blank)</label>
        <textarea id="fCautions" rows="2" placeholder="CAUTION text if any"></textarea>
      </div>
      <div class="field">
        <label>Notes</label>
        <textarea id="fNotes" rows="3" placeholder="Additional notes..."></textarea>
      </div>
      <div class="field">
        <label>Circuit Breakers</label>
        <div class="cb-header">
          <span>PANEL</span><span>DESIGNATION</span><span>FIN</span><span>LOC</span><span>FSN</span><span></span>
        </div>
        <div class="cb-editor" id="cbEditor"></div>
        <button class="btn btn-cyan" style="margin-top:8px;font-size:11px;padding:6px 12px" onclick="addCBRow()">+ ADD ROW</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-red" onclick="closeModal()">CANCEL</button>
      <button class="btn btn-green" onclick="saveEntry()">SAVE ENTRY</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-title">CONFIRM DELETE</div>
    <div class="confirm-msg" id="confirmMsg"></div>
    <div class="confirm-actions">
      <button class="btn btn-amber" onclick="closeConfirm()">CANCEL</button>
      <button class="btn btn-red" id="confirmOK">DELETE</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ── PASSWORD GATE ──
const PW_HASH = "c4fd55b13e3a3f7a4dc41fd22bcb9f49"; // MD5 of 24041987
const SESSION_KEY = "admin_auth";
let failedAttempts = 0;
let lockUntil = 0;

function md5(str) {
  // Simple MD5 implementation
  function safeAdd(x, y) { const lsw=(x&0xFFFF)+(y&0xFFFF); const msw=(x>>16)+(y>>16)+(lsw>>16); return (msw<<16)|(lsw&0xFFFF); }
  function bitRotateLeft(num, cnt) { return (num<<cnt)|(num>>>(32-cnt)); }
  function md5cmn(q,a,b,x,s,t) { return safeAdd(bitRotateLeft(safeAdd(safeAdd(a,q),safeAdd(x,t)),s),b); }
  function md5ff(a,b,c,d,x,s,t) { return md5cmn((b&c)|((~b)&d),a,b,x,s,t); }
  function md5gg(a,b,c,d,x,s,t) { return md5cmn((b&d)|(c&(~d)),a,b,x,s,t); }
  function md5hh(a,b,c,d,x,s,t) { return md5cmn(b^c^d,a,b,x,s,t); }
  function md5ii(a,b,c,d,x,s,t) { return md5cmn(c^(b|(~d)),a,b,x,s,t); }
  function md5blks(s) {
    const nblk=((s.length+8)>>6)+1; const blks=new Array(nblk*16).fill(0);
    let i; for(i=0;i<s.length;i++) blks[i>>2]|=s.charCodeAt(i)<<((i%4)*8);
    blks[i>>2]|=0x80<<((i%4)*8); blks[nblk*16-2]=s.length*8; return blks;
  }
  const blks=md5blks(str);
  let a=1732584193,b=-271733879,c=-1732584194,d=271733878;
  for(let i=0;i<blks.length;i+=16) {
    const [oa,ob,oc,od]=[a,b,c,d];
    a=md5ff(a,b,c,d,blks[i],7,-680876936);d=md5ff(d,a,b,c,blks[i+1],12,-389564586);c=md5ff(c,d,a,b,blks[i+2],17,606105819);b=md5ff(b,c,d,a,blks[i+3],22,-1044525330);
    a=md5ff(a,b,c,d,blks[i+4],7,-176418897);d=md5ff(d,a,b,c,blks[i+5],12,1200080426);c=md5ff(c,d,a,b,blks[i+6],17,-1473231341);b=md5ff(b,c,d,a,blks[i+7],22,-45705983);
    a=md5ff(a,b,c,d,blks[i+8],7,1770035416);d=md5ff(d,a,b,c,blks[i+9],12,-1958414417);c=md5ff(c,d,a,b,blks[i+10],17,-42063);b=md5ff(b,c,d,a,blks[i+11],22,-1990404162);
    a=md5ff(a,b,c,d,blks[i+12],7,1804603682);d=md5ff(d,a,b,c,blks[i+13],12,-40341101);c=md5ff(c,d,a,b,blks[i+14],17,-1502002290);b=md5ff(b,c,d,a,blks[i+15],22,1236535329);
    a=md5gg(a,b,c,d,blks[i+1],5,-165796510);d=md5gg(d,a,b,c,blks[i+6],9,-1069501632);c=md5gg(c,d,a,b,blks[i+11],14,643717713);b=md5gg(b,c,d,a,blks[i],20,-373897302);
    a=md5gg(a,b,c,d,blks[i+5],5,-701558691);d=md5gg(d,a,b,c,blks[i+10],9,38016083);c=md5gg(c,d,a,b,blks[i+15],14,-660478335);b=md5gg(b,c,d,a,blks[i+4],20,-405537848);
    a=md5gg(a,b,c,d,blks[i+9],5,568446438);d=md5gg(d,a,b,c,blks[i+14],9,-1019803690);c=md5gg(c,d,a,b,blks[i+3],14,-187363961);b=md5gg(b,c,d,a,blks[i+8],20,1163531501);
    a=md5gg(a,b,c,d,blks[i+13],5,-1444681467);d=md5gg(d,a,b,c,blks[i+2],9,-51403784);c=md5gg(c,d,a,b,blks[i+7],14,1735328473);b=md5gg(b,c,d,a,blks[i+12],20,-1926607734);
    a=md5hh(a,b,c,d,blks[i+5],4,-378558);d=md5hh(d,a,b,c,blks[i+8],11,-2022574463);c=md5hh(c,d,a,b,blks[i+11],16,1839030562);b=md5hh(b,c,d,a,blks[i+14],23,-35309556);
    a=md5hh(a,b,c,d,blks[i+1],4,-1530992060);d=md5hh(d,a,b,c,blks[i+4],11,1272893353);c=md5hh(c,d,a,b,blks[i+7],16,-155497632);b=md5hh(b,c,d,a,blks[i+10],23,-1094730640);
    a=md5hh(a,b,c,d,blks[i+13],4,681279174);d=md5hh(d,a,b,c,blks[i],11,-358537222);c=md5hh(c,d,a,b,blks[i+3],16,-722521979);b=md5hh(b,c,d,a,blks[i+6],23,76029189);
    a=md5hh(a,b,c,d,blks[i+9],4,-640364487);d=md5hh(d,a,b,c,blks[i+12],11,-421815835);c=md5hh(c,d,a,b,blks[i+15],16,530742520);b=md5hh(b,c,d,a,blks[i+2],23,-995338651);
    a=md5ii(a,b,c,d,blks[i],6,-198630844);d=md5ii(d,a,b,c,blks[i+7],10,1126891415);c=md5ii(c,d,a,b,blks[i+14],15,-1416354905);b=md5ii(b,c,d,a,blks[i+5],21,-57434055);
    a=md5ii(a,b,c,d,blks[i+12],6,1700485571);d=md5ii(d,a,b,c,blks[i+3],10,-1894986606);c=md5ii(c,d,a,b,blks[i+10],15,-1051523);b=md5ii(b,c,d,a,blks[i+1],21,-2054922799);
    a=md5ii(a,b,c,d,blks[i+8],6,1873313359);d=md5ii(d,a,b,c,blks[i+15],10,-30611744);c=md5ii(c,d,a,b,blks[i+6],15,-1560198380);b=md5ii(b,c,d,a,blks[i+13],21,1309151649);
    a=md5ii(a,b,c,d,blks[i+4],6,-145523070);d=md5ii(d,a,b,c,blks[i+11],10,-1120210379);c=md5ii(c,d,a,b,blks[i+2],15,718787259);b=md5ii(b,c,d,a,blks[i+9],21,-343485551);
    a=safeAdd(a,oa);b=safeAdd(b,ob);c=safeAdd(c,oc);d=safeAdd(d,od);
  }
  return [a,b,c,d].map(n=>('0000000'+((n<0)?n+0x100000000:n).toString(16)).slice(-8)).join('').replace(/(.{2})/g,(m,p)=>p).split('').reduce((acc,c,i)=>acc+(i%2===0?'':(acc.slice(-2)+c).split('').reverse().join('')+acc.slice(-2)+c).slice(-2),'');
}

// Simpler approach: just hash comparison using a pre-computed value
function checkPW() {
  const now = Date.now();
  if (now < lockUntil) {
    const secs = Math.ceil((lockUntil - now) / 1000);
    document.getElementById('pwAttempts').textContent = `LOCKED — WAIT ${secs}s`;
    return;
  }

  const entered = document.getElementById('pwInput').value;
  const input = document.getElementById('pwInput');

  // Compare against password directly but obfuscated
  const pw = atob('MjQwNDE5ODc='); // base64 of "24041987"
  if (entered === pw) {
    sessionStorage.setItem(SESSION_KEY, '1');
    document.getElementById('pwGate').classList.add('hidden');
    document.getElementById('app').style.display = '';
    init();
  } else {
    failedAttempts++;
    input.classList.add('error');
    document.getElementById('pwError').classList.add('show');
    setTimeout(() => {
      input.classList.remove('error');
      document.getElementById('pwError').classList.remove('show');
    }, 1500);
    input.value = '';

    if (failedAttempts >= 5) {
      lockUntil = Date.now() + 30000; // 30s lockout
      failedAttempts = 0;
      document.getElementById('pwAttempts').textContent = 'TOO MANY ATTEMPTS — 30s LOCKOUT';
      setTimeout(() => { document.getElementById('pwAttempts').textContent = ''; }, 30000);
    } else {
      const rem = 5 - failedAttempts;
      document.getElementById('pwAttempts').textContent = rem === 1 ? '1 ATTEMPT REMAINING' : `${rem} ATTEMPTS REMAINING`;
    }
    input.focus();
  }
}

// Auto-unlock if already authenticated this session
if (sessionStorage.getItem(SESSION_KEY) === '1') {
  document.getElementById('pwGate').classList.add('hidden');
  document.getElementById('app').style.display = '';
  document.addEventListener('DOMContentLoaded', init);
  if (document.readyState !== 'loading') init();
}

// Focus password input on load
window.addEventListener('DOMContentLoaded', () => {
  if (!sessionStorage.getItem(SESSION_KEY)) {
    setTimeout(() => document.getElementById('pwInput').focus(), 100);
  }
});

// ── STATE ──
let baseDB = { messages: [] };
let db = { messages: [] };
let editingId = null;

// ── INIT ──
async function init() {
  try {
    const res = await fetch('database.json');
    baseDB = await res.json();
  } catch(e) {
    baseDB = { messages: [], version: '1.0', lastUpdated: new Date().toISOString().split('T')[0] };
  }

  const override = localStorage.getItem('db_override');
  if (override) {
    try { db = JSON.parse(override); } catch { db = JSON.parse(JSON.stringify(baseDB)); }
  } else {
    db = JSON.parse(JSON.stringify(baseDB));
  }

  buildATAFilter();
  renderList();
  refreshGHStatus();
}

function buildATAFilter() {
  const sel = document.getElementById('filterATA');
  const atas = [...new Set(db.messages.map(m => m.ata))].sort();
  sel.innerHTML = '<option value="">ALL ATA</option>' +
    atas.map(a => `<option value="${a}">ATA ${a}</option>`).join('');
}

function saveToStorage() {
  db.lastUpdated = new Date().toISOString().split('T')[0];
  localStorage.setItem('db_override', JSON.stringify(db));
}

// ── LIST ──
function renderList() {
  const q = document.getElementById('filterInput').value.toLowerCase();
  const ac = document.getElementById('filterAC').value;
  const ata = document.getElementById('filterATA').value;

  const filtered = db.messages.filter(msg => {
    if (ac && !msg.aircraft.includes(ac)) return false;
    if (ata && msg.ata !== ata) return false;
    if (q && !msg.ecamMessages.some(m => m.toLowerCase().includes(q)) &&
        !msg.computer.toLowerCase().includes(q) &&
        !msg.ata.includes(q)) return false;
    return true;
  });

  const container = document.getElementById('msgList');

  // Stats
  const total = db.messages.length;
  const ceoCount = db.messages.filter(m => m.aircraft.includes('CEO')).length;
  const neoCount = db.messages.filter(m => m.aircraft.includes('NEO')).length;
  document.getElementById('statsBar').innerHTML = `
    TOTAL: <span>${total}</span> &nbsp;|&nbsp;
    CEO: <span>${ceoCount}</span> &nbsp;|&nbsp;
    NEO: <span>${neoCount}</span> &nbsp;|&nbsp;
    FILTERED: <span>${filtered.length}</span>
    &nbsp;|&nbsp;
    ${localStorage.getItem('db_override') ? '<span style="color:var(--amber)">★ LOCAL OVERRIDES ACTIVE</span>' : '<span style="color:var(--green-dim)">BASE DATABASE</span>'}
  `;

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty">NO ENTRIES MATCH FILTER</div>';
    return;
  }

  container.innerHTML = filtered.map(msg => {
    const acLabel = msg.aircraft.length === 2 ? 'CEO + NEO' : msg.aircraft[0];
    const acClass = msg.aircraft.length === 2 ? 'tag-both' : (msg.aircraft[0] === 'CEO' ? 'tag-ceo' : 'tag-neo');
    const msgsHtml = msg.ecamMessages.slice(0, 3).map(m => `<span class="row-msg">${m}</span>`).join('');
    const extra = msg.ecamMessages.length > 3 ? `<span class="row-msg" style="color:var(--text-dim)">+${msg.ecamMessages.length-3} more</span>` : '';
    return `<div class="msg-row" data-id="${msg.id}">
      <div class="row-msgs">${msgsHtml}${extra}</div>
      <div class="row-meta">
        <span class="tag tag-ata">ATA ${msg.ata}</span>
        <span class="tag ${acClass}">${acLabel}</span>
        <span class="row-actions">
          <button class="row-btn edit-btn" onclick="openEditModal('${msg.id}');event.stopPropagation()">EDIT</button>
          <button class="row-btn del-btn" onclick="confirmDelete('${msg.id}');event.stopPropagation()">DEL</button>
        </span>
      </div>
    </div>`;
  }).join('');
}

// ── MODAL ──
function openAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'ADD ENTRY';
  clearForm();
  addCBRow();
  document.getElementById('modalOverlay').classList.add('open');
}

function openEditModal(id) {
  const msg = db.messages.find(m => m.id === id);
  if (!msg) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'EDIT ENTRY';
  clearForm();

  document.getElementById('fMsgs').value = msg.ecamMessages.join('\n');
  document.getElementById('fATA').value = msg.ata;
  document.getElementById('fComputer').value = msg.computer;
  document.getElementById('fCEO').checked = msg.aircraft.includes('CEO');
  document.getElementById('fNEO').checked = msg.aircraft.includes('NEO');
  document.getElementById('fProc').value = msg.resetProcedure;
  document.getElementById('fWarnings').value = msg.warnings.join('\n');
  document.getElementById('fCautions').value = msg.cautions.join('\n');
  document.getElementById('fNotes').value = msg.notes || '';

  const editor = document.getElementById('cbEditor');
  editor.innerHTML = '';
  (msg.cbTable || []).forEach(cb => addCBRow(cb));

  document.getElementById('modalOverlay').classList.add('open');
}

function clearForm() {
  ['fMsgs','fATA','fComputer','fProc','fWarnings','fCautions','fNotes'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('fCEO').checked = true;
  document.getElementById('fNEO').checked = false;
  document.getElementById('cbEditor').innerHTML = '';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  editingId = null;
}

function addCBRow(cb) {
  const row = document.createElement('div');
  row.className = 'cb-row';
  const p = cb?.panel || '';
  const d = cb?.designation || '';
  const f = cb?.fin || '';
  const l = cb?.location || '';
  const s = cb?.fsn || 'ALL';
  row.innerHTML = `
    <input type="text" placeholder="49VU" value="${p}">
    <input type="text" placeholder="DESIGNATION" value="${d}">
    <input type="text" placeholder="FIN" value="${f}">
    <input type="text" placeholder="LOC" value="${l}">
    <input type="text" placeholder="ALL" value="${s}">
    <button class="remove-cb" onclick="this.parentElement.remove()">✕</button>
  `;
  document.getElementById('cbEditor').appendChild(row);
}

function saveEntry() {
  const msgs = document.getElementById('fMsgs').value.trim().split('\n').map(s=>s.trim()).filter(Boolean);
  const ata = document.getElementById('fATA').value.trim();
  const computer = document.getElementById('fComputer').value.trim();
  const ceo = document.getElementById('fCEO').checked;
  const neo = document.getElementById('fNEO').checked;
  const proc = document.getElementById('fProc').value.trim();

  if (!msgs.length || !ata || !computer || !proc) {
    showToast('FILL IN REQUIRED FIELDS', true); return;
  }
  if (!ceo && !neo) { showToast('SELECT AT LEAST ONE AIRCRAFT TYPE', true); return; }

  const aircraft = [...(ceo ? ['CEO'] : []), ...(neo ? ['NEO'] : [])];
  const warnings = document.getElementById('fWarnings').value.trim().split('\n').map(s=>s.trim()).filter(Boolean);
  const cautions = document.getElementById('fCautions').value.trim().split('\n').map(s=>s.trim()).filter(Boolean);
  const notes = document.getElementById('fNotes').value.trim();

  const cbRows = document.getElementById('cbEditor').querySelectorAll('.cb-row');
  const cbTable = [...cbRows].map(row => {
    const inputs = row.querySelectorAll('input');
    return { panel: inputs[0].value, designation: inputs[1].value, fin: inputs[2].value, location: inputs[3].value, fsn: inputs[4].value };
  }).filter(cb => cb.panel || cb.fin);

  const id = editingId || msgs[0].toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'') + '-' + Date.now();

  const entry = { id, aircraft, ecamMessages: msgs, ata, computer, resetProcedure: proc, notes, warnings, cautions, cbTable };

  if (editingId) {
    const idx = db.messages.findIndex(m => m.id === editingId);
    if (idx >= 0) db.messages[idx] = entry;
  } else {
    db.messages.push(entry);
  }

  saveToStorage();
  buildATAFilter();
  renderList();
  closeModal();
  const action = editingId ? 'Update' : 'Add';
  const label = `${action}: ${msgs[0]}`;
  showToast(editingId ? 'ENTRY UPDATED' : 'ENTRY ADDED');
  pushToGitHub(label);
}

// ── DELETE ──
let pendingDeleteId = null;

function confirmDelete(id) {
  const msg = db.messages.find(m => m.id === id);
  pendingDeleteId = id;
  document.getElementById('confirmMsg').textContent =
    `Delete "${msg?.ecamMessages[0]}"? This cannot be undone without reimporting.`;
  document.getElementById('confirmOK').onclick = () => { deleteEntry(id); closeConfirm(); };
  document.getElementById('confirmOverlay').classList.add('open');
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('open');
  pendingDeleteId = null;
}

function deleteEntry(id) {
  const msg = db.messages.find(m => m.id === id);
  const label = `Delete: ${msg?.ecamMessages?.[0] || id}`;
  db.messages = db.messages.filter(m => m.id !== id);
  saveToStorage();
  buildATAFilter();
  renderList();
  showToast('ENTRY DELETED');
  pushToGitHub(label);
}

// ── IMPORT / EXPORT ──
function exportDB() {
  const json = JSON.stringify(db, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'database.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('EXPORTED database.json — COMMIT TO REPO TO PERSIST');
}

function importDB(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.messages || !Array.isArray(imported.messages)) throw new Error('Invalid format');
      db = imported;
      saveToStorage();
      buildATAFilter();
      renderList();
      showToast(`IMPORTED ${db.messages.length} ENTRIES`);
    } catch(err) {
      showToast('IMPORT FAILED: ' + err.message, true);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearOverride() {
  localStorage.removeItem('db_override');
  db = JSON.parse(JSON.stringify(baseDB));
  buildATAFilter();
  renderList();
  showToast('RESET TO BASE DATABASE');
}

// ── GITHUB SYNC ──
const GH_KEYS = { owner:'gh_owner', repo:'gh_repo', branch:'gh_branch', token:'gh_token' };
const GH_FILE_PATH = 'database.json';

function getGHConfig() {
  return {
    owner:  localStorage.getItem(GH_KEYS.owner)  || '',
    repo:   localStorage.getItem(GH_KEYS.repo)   || '',
    branch: localStorage.getItem(GH_KEYS.branch) || '',
    token:  localStorage.getItem(GH_KEYS.token)  || '',
  };
}

function ghIsConfigured() {
  const c = getGHConfig();
  return !!(c.owner && c.repo && c.branch && c.token);
}

function updateGHStatus(state, text) {
  const dot = document.getElementById('ghDot');
  const label = document.getElementById('ghLabel');
  dot.className = 'gh-dot ' + state;
  label.innerHTML = text;
}

function refreshGHStatus() {
  if (!ghIsConfigured()) {
    updateGHStatus('off', 'GITHUB SYNC NOT CONFIGURED — click settings to enable auto-push');
    return;
  }
  const c = getGHConfig();
  updateGHStatus('ok', `AUTO-PUSH ENABLED → <strong>${c.owner}/${c.repo}</strong> · branch <strong>${c.branch}</strong>`);
}

async function pushToGitHub(actionLabel) {
  if (!ghIsConfigured()) return; // silently skip — not configured

  const c = getGHConfig();
  const apiBase = `https://api.github.com/repos/${c.owner}/${c.repo}/contents/${GH_FILE_PATH}`;
  const headers = {
    'Authorization': `token ${c.token}`,
    'Accept': 'application/vnd.github+json',
    'Content-Type': 'application/json',
  };

  updateGHStatus('busy', 'PUSHING TO GITHUB…');

  try {
    // Step 1: get current file SHA (required for update)
    const getRes = await fetch(`${apiBase}?ref=${encodeURIComponent(c.branch)}`, { headers });
    let sha = null;
    if (getRes.ok) {
      const meta = await getRes.json();
      sha = meta.sha;
    } else if (getRes.status !== 404) {
      throw new Error(`GitHub GET failed: ${getRes.status} ${getRes.statusText}`);
    }

    // Step 2: base64-encode the new database content
    const json = JSON.stringify(db, null, 2);
    // btoa doesn't handle unicode — use TextEncoder
    const bytes = new TextEncoder().encode(json);
    let binary = '';
    bytes.forEach(b => binary += String.fromCharCode(b));
    const content = btoa(binary);

    // Step 3: PUT to update the file
    const now = new Date().toISOString().replace('T',' ').slice(0,16);
    const body = {
      message: `${actionLabel} — ${now} UTC (admin panel)`,
      content,
      branch: c.branch,
      ...(sha ? { sha } : {})
    };

    const putRes = await fetch(apiBase, {
      method: 'PUT',
      headers,
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const err = await putRes.json().catch(() => ({}));
      throw new Error(err.message || `${putRes.status} ${putRes.statusText}`);
    }

    const result = await putRes.json();
    const shortSha = result.commit?.sha?.slice(0, 7) || '?';
    updateGHStatus('ok', `PUSHED ✓ commit <strong>${shortSha}</strong> → <strong>${c.owner}/${c.repo}:${c.branch}</strong>`);
    showToast(`COMMITTED TO GITHUB · ${shortSha}`);

  } catch(e) {
    updateGHStatus('err', `PUSH FAILED: ${e.message}`);
    showToast('GITHUB PUSH FAILED — see status bar', true);
    console.error('GitHub push error:', e);
  }
}

// ── GITHUB SETTINGS MODAL ──
function openGHSettings() {
  const c = getGHConfig();
  document.getElementById('ghOwner').value  = c.owner;
  document.getElementById('ghRepo').value   = c.repo;
  document.getElementById('ghBranch').value = c.branch;
  document.getElementById('ghToken').value  = c.token;
  document.getElementById('ghTestMsg').textContent = '';
  document.getElementById('ghModal').classList.add('open');
}

function closeGHSettings() {
  document.getElementById('ghModal').classList.remove('open');
}

function saveGHSettings() {
  localStorage.setItem(GH_KEYS.owner,  document.getElementById('ghOwner').value.trim());
  localStorage.setItem(GH_KEYS.repo,   document.getElementById('ghRepo').value.trim());
  localStorage.setItem(GH_KEYS.branch, document.getElementById('ghBranch').value.trim());
  localStorage.setItem(GH_KEYS.token,  document.getElementById('ghToken').value.trim());
  refreshGHStatus();
  closeGHSettings();
  showToast('GITHUB SETTINGS SAVED');
}

function clearGHSettings() {
  Object.values(GH_KEYS).forEach(k => localStorage.removeItem(k));
  ['ghOwner','ghRepo','ghBranch','ghToken'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('ghTestMsg').textContent = '';
  refreshGHStatus();
  showToast('GITHUB SETTINGS CLEARED');
}

async function testGHConnection() {
  const owner  = document.getElementById('ghOwner').value.trim();
  const repo   = document.getElementById('ghRepo').value.trim();
  const branch = document.getElementById('ghBranch').value.trim();
  const token  = document.getElementById('ghToken').value.trim();
  const msg    = document.getElementById('ghTestMsg');

  if (!owner || !repo || !branch || !token) {
    msg.style.color = 'var(--red)'; msg.textContent = 'FILL IN ALL FIELDS FIRST'; return;
  }

  msg.style.color = 'var(--amber)'; msg.textContent = 'TESTING…';

  try {
    const res = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/contents/${GH_FILE_PATH}?ref=${encodeURIComponent(branch)}`,
      { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json' } }
    );
    if (res.status === 200) {
      msg.style.color = 'var(--green)'; msg.textContent = '✓ CONNECTED — database.json found';
    } else if (res.status === 404) {
      msg.style.color = 'var(--amber)'; msg.textContent = '⚠ REPO OK BUT database.json NOT FOUND (will be created)';
    } else if (res.status === 401) {
      msg.style.color = 'var(--red)'; msg.textContent = '✗ TOKEN REJECTED — check PAT permissions';
    } else {
      msg.style.color = 'var(--red)'; msg.textContent = `✗ ERROR ${res.status}`;
    }
  } catch(e) {
    msg.style.color = 'var(--red)'; msg.textContent = '✗ NETWORK ERROR — check token / repo';
  }
}

// ── TOAST ──
function showToast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = isError ? 'var(--red-dim)' : 'var(--green-dim)';
  t.style.color = isError ? 'var(--red)' : 'var(--green)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Close modal on overlay click
document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});
</script>
</body>
</html>
